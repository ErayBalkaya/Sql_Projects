--1.What are the details of all cars purchased in the year 2022?

SELECT DISTINCT(C.CAR_ID),
	CONCAT (MAKE,' ',TYPE),STYLE,COST
FROM CARS C
LEFT JOIN SALES S ON C.CAR_ID = S.CAR_ID
WHERE TO_CHAR(PURCHASE_DATE,'YYYY') = '2022' 

--2. What is the total number of cars sold by each salesperson?

SELECT SP.NAME,	S.SALESMAN_ID,COUNT(S.*) TOTAL_SALES
FROM SALES S
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
GROUP BY 1,2
ORDER BY 3 DESC 

--3. What is the total revenue generated by each salesperson?

SELECT SP.NAME,
	S.SALESMAN_ID,
	SUM(C.COST) TOTAL_REVENUE
FROM SALES S
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
LEFT JOIN CARS C ON C.CAR_ID = S.CAR_ID
GROUP BY 1,2
ORDER BY 3 DESC 

--4.What are the details of the cars sold by each salesperson?

SELECT DISTINCT S.SALESMAN_ID,
	SP.NAME,
	C.CAR_ID,
	C.MAKE,
	C.TYPE,
	C.STYLE,
	C.COST
FROM SALES S
JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
JOIN CARS C ON C.CAR_ID = S.CAR_ID
ORDER BY SALESMAN_ID,CAR_ID 
	
--5. What is the total revenue generated by each car type?

SELECT C.CAR_ID,
	C.MAKE,
	C.TYPE,
	C.STYLE,
	SUM(C.COST) TOTAL_REVENUE
FROM CARS C
JOIN SALES S ON C.CAR_ID = S.CAR_ID
GROUP BY C.CAR_ID
ORDER BY 5 DESC 

--6. What are the details of the cars sold in the year 2021 by salesperson 'Emily Wong'?

SELECT C.CAR_ID,
	CONCAT (MAKE,' ',TYPE),STYLE,COST
FROM CARS C
LEFT JOIN SALES S ON C.CAR_ID = S.CAR_ID
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
WHERE TO_CHAR(PURCHASE_DATE,'YYYY') = '2021'
	AND NAME = 'Emily Wong' 

--7. What is the total revenue generated by the sales of hatchback cars?

SELECT C.CAR_ID,
		C.MAKE,
		C.TYPE,
		C.STYLE,
		SUM(C.COST) TOTAL_REVENUE
FROM CARS C
JOIN SALES S ON C.CAR_ID = S.CAR_ID 
WHERE STYLE = 'Hatchback'
GROUP BY 1,3 

--8. What is the total revenue generated by the sales of SUV cars in the year 2022?

SELECT C.STYLE,
	SUM(C.COST) TOTAL_REVENUE
FROM CARS C
JOIN SALES S ON C.CAR_ID = S.CAR_ID
WHERE TO_CHAR(S.PURCHASE_DATE,'YYYY') = '2022'
	AND STYLE = 'SUV'
GROUP BY 1 

--9. What is the name and city of the salesperson who sold the most number of cars in the year 2023?

SELECT S.SALESMAN_ID,
	SP.NAME,
	SP.CITY
FROM SALES S
JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
WHERE TO_CHAR(PURCHASE_DATE,'YYYY') = '2023'
GROUP BY 1,2,3
ORDER BY COUNT(S.SALESMAN_ID) DESC
LIMIT 1 

--10. What is the name and age of the salesperson who generated the highest revenue in the year 2022?

SELECT SP.NAME,
	SP.AGE
FROM SALES S
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
LEFT JOIN CARS C ON C.CAR_ID = S.CAR_ID
WHERE TO_CHAR(PURCHASE_DATE,'YYYY') = '2022'
GROUP BY 1,2
ORDER BY SUM(C.COST) DESC
LIMIT 1 

--11.Who generated the highest revenues every year?

WITH DATAB AS
	(SELECT SP.NAME,
			SUM(C.COST) TOTAL_REVENUE,
			EXTRACT(YEAR FROM S.PURCHASE_DATE) YEAR_,
			DENSE_RANK() OVER (PARTITION BY EXTRACT(YEAR FROM S.PURCHASE_DATE)																						ORDER BY SUM(C.COST) DESC) SALES_RANK
	FROM SALES S
	LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
	LEFT JOIN CARS C ON C.CAR_ID = S.CAR_ID
	GROUP BY 1,3
	ORDER BY YEAR_)
SELECT *
FROM DATAB
WHERE SALES_RANK = 1 

--12.What are the amounts of the cars sold?

SELECT DISTINCT(C.CAR_ID),
		CONCAT (MAKE,' ',TYPE) MARKA,
		STYLE,
		COUNT(S.CAR_ID) TOTAL_AMOUNT
FROM CARS C
LEFT JOIN SALES S ON C.CAR_ID = S.CAR_ID
GROUP BY C.CAR_ID
ORDER BY 4 DESC 

--13.Show the amount and the revenue of each sales person.

SELECT SP.NAME,
	COUNT(S.SALESMAN_ID) SELL_AMOUNT,
	SUM(C.COST)TOTAL_REVENUE
FROM SALES S
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
LEFT JOIN CARS C ON C.CAR_ID = S.CAR_ID
GROUP BY 1
ORDER BY 2 DESC 

--14.What are the percentage rates of salespersons?

SELECT SP.NAME,
	COUNT(S.SALESMAN_ID) SELL_AMOUNT,
	SUM(C.COST)TOTAL_REVENUE,
	ROUND((COUNT(S.SALESMAN_ID) / SUM(COUNT(S.SALESMAN_ID)) OVER ()),2) * 100 AS PERCENTAGE_OF_AMOUNT,
	ROUND((SUM(C.COST) / SUM(SUM(C.COST)) OVER ()),2) * 100 AS PERCENTAGE_OF_REVENUE
FROM SALES S
LEFT JOIN SALESPERSONS SP ON S.SALESMAN_ID = SP.SALESMAN_ID
LEFT JOIN CARS C ON C.CAR_ID = S.CAR_ID
GROUP BY 1
ORDER BY 2 DESC 

--15.How many sales were made in each city?

SELECT SALESPERSONS.CITY,
	COUNT(*) AS TOTAL_SALES
FROM SALESPERSONS
JOIN SALES ON SALESPERSONS.SALESMAN_ID = SALES.SALESMAN_ID
GROUP BY SALESPERSONS.CITY;
